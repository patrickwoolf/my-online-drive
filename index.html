<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Patrick's Spreadsheet Drive</title>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet/dist/css/luckysheet.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet/dist/assets/iconfont/iconfont.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet/dist/luckysheet.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <style>
        :root { --sidebar-width: 260px; --top-height: 60px; --gh-dark: #24292e; }
        body { margin: 0; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* Header */
        #header { height: var(--top-height); background: var(--gh-dark); color: white; display: flex; align-items: center; padding: 0 20px; gap: 15px; z-index: 100; }
        #header input { background: #3f4448; border: 1px solid #444d56; color: white; padding: 8px; border-radius: 4px; }
        
        /* Layout */
        #main-container { display: flex; flex: 1; position: relative; }
        
        /* Sidebar */
        #sidebar { width: var(--sidebar-width); background: #f6f8fa; border-right: 1px solid #d0d7de; display: flex; flex-direction: column; }
        #file-list-header { padding: 15px; border-bottom: 1px solid #d0d7de; display: flex; justify-content: space-between; align-items: center; }
        #file-list { flex: 1; overflow-y: auto; list-style: none; margin: 0; padding: 0; }
        .file-item { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .file-item:hover { background: #ebf0f4; }
        .file-item.active { background: #0969da; color: white; }
        .file-actions { display: none; gap: 5px; }
        .file-item:hover .file-actions { display: flex; }
        .btn-icon { background: none; border: none; cursor: pointer; padding: 2px; font-size: 12px; }

        /* Spreadsheet Area */
        #luckysheet { flex: 1; position: relative !important; }

        /* Buttons */
        .btn { padding: 8px 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-primary { background: #2ea44f; color: white; }
        .btn-outline { background: white; border: 1px solid #d0d7de; }
    </style>
</head>
<body>

<div id="header">
    <strong>Patrick's Drive</strong>
    <input type="password" id="token" placeholder="GitHub Token">
    <button class="btn btn-primary" onclick="refreshFiles()">Connect / Refresh</button>
    <button class="btn btn-outline" onclick="saveCurrentFile()">üíæ Save Cloud</button>
    <span id="status" style="font-size: 12px; opacity: 0.8;">Offline</span>
</div>

<div id="main-container">
    <div id="sidebar">
        <div id="file-list-header">
            <span>Files (.json)</span>
            <button class="btn-icon" onclick="createNewFile()" title="New Spreadsheet">‚ûï New</button>
        </div>
        <ul id="file-list">
            </ul>
    </div>
    <div id="luckysheet"></div>
</div>

<script>
    const REPO = "patrickwoolf/my-online-drive";
    let currentFileName = null;
    let currentSha = null;

    window.onload = () => {
        const saved = localStorage.getItem('gh_token');
        if (saved) { document.getElementById('token').value = saved; refreshFiles(); }
        luckysheet.create({ container: 'luckysheet', lang: 'en' });
    };

    async function ghFetch(path, options = {}) {
        const token = document.getElementById('token').value;
        const headers = { 
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github+json',
            ...options.headers 
        };
        const response = await fetch(`https://api.github.com/repos/${REPO}/${path}`, { ...options, headers });
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.message || "GitHub API Error");
        }
        return response.json();
    }

    async function refreshFiles() {
        const token = document.getElementById('token').value;
        if (!token) return;
        localStorage.setItem('gh_token', token);
        
        try {
            const data = await ghFetch('contents/');
            const files = data.filter(f => f.name.endsWith('.json'));
            const listEl = document.getElementById('file-list');
            listEl.innerHTML = '';
            
            files.forEach(file => {
                const li = document.createElement('li');
                li.className = `file-item ${currentFileName === file.name ? 'active' : ''}`;
                li.innerHTML = `
                    <span onclick="loadFile('${file.name}')">${file.name}</span>
                    <div class="file-actions">
                        <button class="btn-icon" onclick="renameFile('${file.name}', '${file.sha}')">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteFile('${file.name}', '${file.sha}')">üóëÔ∏è</button>
                    </div>
                `;
                listEl.appendChild(li);
            });
            document.getElementById('status').innerText = "Connected";
        } catch (e) { alert(e.message); }
    }

    async function saveCurrentFile() {
        if (!currentFileName || !currentSha) return alert("Select a file first!");
        document.getElementById('status').innerText = "Compressing & Saving...";
    
        try {
            // 1. Get raw data
            const data = luckysheet.getAllSheets();
            const jsonString = JSON.stringify(data);
            
            // 2. Compress the string using Pako (Gzip)
            const compressed = pako.gzip(jsonString);
            
            // 3. Convert Uint8Array to Base64 (Standard GitHub requirement)
            const base64Content = btoa(String.fromCharCode.apply(null, compressed));
    
            const res = await ghReq(`contents/${currentFileName}`, {
                method: 'PUT',
                body: JSON.stringify({ 
                    message: `Compressed Save: ${new Date().toISOString()}`, 
                    content: base64Content, 
                    sha: currentSha 
                })
            });
    
            currentSha = res.content.sha;
            document.getElementById('status').innerText = "üöÄ Saved (Compressed)";
        } catch (e) {
            alert("Save Failed: " + e.message);
        }
    }
    
    async function loadFile(name) {
        document.getElementById('status').innerText = `Decompressing ${name}...`;
        try {
            const file = await ghReq(`contents/${name}?t=${Date.now()}`);
            currentFileName = name;
            currentSha = file.sha;
    
            // 1. Convert Base64 to Binary String
            const binaryString = atob(file.content);
            
            // 2. Convert Binary String to Uint8Array
            const charData = binaryString.split('').map(x => x.charCodeAt(0));
            const binData = new Uint8Array(charData);
    
            let jsonData;
            try {
                // 3. Try to decompress (for new compressed files)
                const decompressed = pako.ungzip(binData, { to: 'string' });
                jsonData = JSON.parse(decompressed);
            } catch (err) {
                // 4. Fallback for your old, uncompressed 1.6MB files
                console.log("Not a compressed file, loading as raw JSON...");
                const decoded = decodeURIComponent(escape(binaryString));
                jsonData = JSON.parse(decoded);
            }
    
            luckysheet.destroy();
            luckysheet.create({
                container: 'luckysheet',
                data: jsonData,
                title: name
            });
    
            refreshFiles();
            document.getElementById('status').innerText = `Editing: ${name}`;
        } catch (e) {
            alert("Load Failed: " + e.message);
        }
    }

    async function createNewFile() {
        const name = prompt("Enter new filename (e.g., budget.json):");
        if (!name || !name.endsWith('.json')) return alert("Filename must end in .json");
        
        try {
            const content = btoa("[]");
            await ghFetch(`contents/${name}`, {
                method: 'PUT',
                body: JSON.stringify({ message: `Create ${name}`, content })
            });
            refreshFiles();
        } catch (e) { alert(e.message); }
    }

    async function deleteFile(name, sha) {
        if (!confirm(`Delete ${name} permanently?`)) return;
        try {
            await ghFetch(`contents/${name}`, {
                method: 'DELETE',
                body: JSON.stringify({ message: `Delete ${name}`, sha })
            });
            if (currentFileName === name) location.reload();
            refreshFiles();
        } catch (e) { alert(e.message); }
    }

    async function renameFile(oldName, sha) {
        const newName = prompt("New name:", oldName);
        if (!newName || newName === oldName) return;
        
        try {
            // GitHub "Rename" is actually Copy + Delete
            const fileData = await ghFetch(`contents/${oldName}`);
            await ghFetch(`contents/${newName}`, {
                method: 'PUT',
                body: JSON.stringify({ message: `Rename from ${oldName}`, content: fileData.content })
            });
            await ghFetch(`contents/${oldName}`, {
                method: 'DELETE',
                body: JSON.stringify({ message: `Cleanup old file`, sha: fileData.sha })
            });
            refreshFiles();
        } catch (e) { alert(e.message); }
    }
</script>
</body>
</html>
