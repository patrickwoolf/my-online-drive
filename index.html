<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Patrick's Modern Drive</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortune-sheet/variant/dist/index.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@fortune-sheet/variant/dist/index.min.js"></script>

    <style>
        :root { --sidebar-width: 280px; --gh-dark: #1f2328; --active-blue: #0969da; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, system-ui, sans-serif; }
        #header { height: 50px; background: var(--gh-dark); color: white; display: flex; align-items: center; padding: 0 10px; gap: 10px; z-index: 1000; }
        #header input { background: #2d333b; border: 1px solid #444c56; color: white; padding: 6px; border-radius: 6px; width: 120px; flex-grow: 1; }
        #menu-toggle { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
        #main-container { display: flex; height: calc(100% - 50px); width: 100%; position: relative; }
        #sidebar { 
            width: var(--sidebar-width); background: #f6f8fa; border-right: 1px solid #d0d7de; 
            display: flex; flex-direction: column; position: absolute; height: 100%; z-index: 999;
            transition: transform 0.25s ease; left: 0;
        }
        #sidebar.collapsed { transform: translateX(-100%); }
        #file-list-header { padding: 15px; border-bottom: 1px solid #d0d7de; display: flex; justify-content: space-between; align-items: center; font-weight: bold; background: #fff; }
        #file-list { flex: 1; overflow-y: auto; list-style: none; margin: 0; padding: 0; }
        .file-item { padding: 12px 15px; border-bottom: 1px solid #e1e4e8; cursor: pointer; background: #f6f8fa; border-left: 4px solid transparent; }
        .file-item.active { border-left: 4px solid var(--active-blue); background: #fff; }
        .file-ops { display: flex; gap: 6px; margin-top: 8px; }
        #sheet-container { flex: 1; height: 100%; width: 100%; position: relative; background: #fff; }
        .btn { padding: 6px 12px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; }
        .btn-mini { padding: 4px 8px; font-size: 11px; background: #fff; border: 1px solid #d0d7de; border-radius: 4px; }
        #status { font-size: 11px; color: #8b949e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        @media (min-width: 768px) { #sidebar { position: relative; transform: none !important; } #header input { width: 200px; flex-grow: 0; } #menu-toggle { display: none; } }
    </style>
</head>
<body>

<div id="header">
    <button id="menu-toggle" onclick="toggleSidebar()">â˜°</button>
    <input type="password" id="token" placeholder="GitHub Token">
    <button class="btn" style="background:#2ea44f; color:white;" onclick="connectAndRefresh()">ðŸ”„ Sync</button>
    <button class="btn" style="background:#0969da; color:white;" onclick="saveCurrentFile()">ðŸ’¾ Save</button>
    <span id="status">Ready</span>
</div>

<div id="main-container">
    <div id="sidebar" class="collapsed">
        <div id="file-list-header">
            <span>Drive</span>
            <button onclick="createNewFile()" class="btn-mini" style="background:#2ea44f; color:white; border:none;">ï¼‹ New</button>
        </div>
        <ul id="file-list"></ul>
    </div>
    <div id="sheet-container"></div>
</div>

<script>
    const REPO = "patrickwoolf/my-online-drive";
    let currentFileName = null;
    let currentSha = null;
    let workbook = null;

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }

    window.onload = () => {
        const saved = localStorage.getItem('gh_token');
        if (saved) { document.getElementById('token').value = saved; connectAndRefresh(); }
        initSheet([{ name: "Sheet1", celldata: [], status: 1 }]);
    };

    function initSheet(data) {
        const f = window.FortuneSheet || window.fortune;
        if (!f) return console.error("Library not loaded.");
        
        // Ensure data is an array
        const validData = Array.isArray(data) ? data : [data];

        const container = document.getElementById("sheet-container");
        container.innerHTML = ''; 

        // Fix for "Blank" screen: ensure container has height/width before calling create
        setTimeout(() => {
            workbook = f.create({
                container: "sheet-container",
                data: validData,
                lang: 'en',
                showToolbar: true,
                showGridlines: true,
                allowEdit: true
            });
        }, 50);
    }

    async function ghApi(path, method = 'GET', body = null) {
        const token = document.getElementById('token').value;
        const options = {
            method,
            headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github+json', 'Content-Type': 'application/json' }
        };
        if (body) options.body = JSON.stringify(body);
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, options);
        if (!res.ok) throw new Error("API Error: " + res.status);
        return res.json();
    }

    async function connectAndRefresh() {
        const token = document.getElementById('token').value;
        if (!token) return;
        localStorage.setItem('gh_token', token);
        try {
            const data = await ghApi(`?t=${Date.now()}`);
            const files = data.filter(f => f.name.endsWith('.json'));
            const listEl = document.getElementById('file-list');
            listEl.innerHTML = '';
            files.forEach(file => {
                const li = document.createElement('li');
                li.className = `file-item ${currentFileName === file.name ? 'active' : ''}`;
                li.innerHTML = `
                    <div onclick="loadFile('${file.name}')" style="font-weight:600">ðŸ“„ ${file.name}</div>
                    <div class="file-ops">
                        <button class="btn-mini" onclick="renameFile('${file.name}')">Ren</button>
                        <button class="btn-mini" onclick="copyFile('${file.name}')">Copy</button>
                        <button class="btn-mini" style="color:#cf222e" onclick="deleteFile('${file.name}', '${file.sha}')">Del</button>
                    </div>
                `;
                listEl.appendChild(li);
            });
            document.getElementById('status').innerText = "Online";
        } catch (e) { alert(e.message); }
    }

    async function loadFile(name) {
        if (window.innerWidth < 768) toggleSidebar();
        document.getElementById('status').innerText = "Loading...";
        try {
            const file = await ghApi(`${name}?t=${Date.now()}`);
            currentFileName = name;
            currentSha = file.sha;
            
            const binaryString = atob(file.content);
            const binData = new Uint8Array(binaryString.split('').map(x => x.charCodeAt(0)));
            let jsonData;
            
            try { 
                jsonData = JSON.parse(pako.ungzip(binData, { to: 'string' })); 
            } catch (err) { 
                // Fallback to legacy plain JSON if decompression fails
                try {
                    jsonData = JSON.parse(decodeURIComponent(escape(binaryString)));
                } catch(e) {
                    jsonData = JSON.parse(binaryString); // Pure raw fallback
                }
            }

            initSheet(jsonData);
            document.getElementById('status').innerText = name;
            connectAndRefresh(); 
        } catch (e) { 
            console.error(e);
            alert("Load Failed: Check console for JSON errors."); 
        }
    }

    async function saveCurrentFile() {
        if (!currentFileName || !workbook) return alert("Open a file first!");
        document.getElementById('status').innerText = "Saving...";
        try {
            const data = workbook.getAllSheets();
            const compressed = pako.gzip(JSON.stringify(data));
            const content = btoa(String.fromCharCode.apply(null, compressed));
            const res = await ghApi(currentFileName, 'PUT', { message: "Cloud Save", content, sha: currentSha });
            currentSha = res.content.sha;
            document.getElementById('status').innerText = "ðŸš€ Saved";
        } catch (e) { alert("Save failed: " + e.message); }
    }

    async function createNewFile() {
        let name = prompt("Name:");
        if (!name) return;
        if (!name.endsWith('.json')) name += '.json';
        const compressed = pako.gzip(JSON.stringify([{ name: "Sheet1", celldata: [], status: 1 }]));
        await ghApi(name, 'PUT', { message: "Create", content: btoa(String.fromCharCode.apply(null, compressed)) });
        connectAndRefresh();
    }

    async function renameFile(oldName) {
        let newName = prompt("New name:", oldName);
        if (!newName || newName === oldName) return;
        const fileData = await ghApi(oldName);
        await ghApi(newName, 'PUT', { message: "Rename", content: fileData.content });
        await ghApi(oldName, 'DELETE', { message: "Cleanup", sha: fileData.sha });
        connectAndRefresh();
    }

    async function copyFile(sourceName) {
        let newName = prompt("Copy name:", "Copy_" + sourceName);
        if (!newName) return;
        const fileData = await ghApi(sourceName);
        await ghApi(newName, 'PUT', { message: "Copy", content: fileData.content });
        connectAndRefresh();
    }

    async function deleteFile(name, sha) {
        if (!confirm(`Delete ${name}?`)) return;
        await ghApi(name, 'DELETE', { message: "Delete", sha });
        if (currentFileName === name) location.reload();
        connectAndRefresh();
    }
</script>
</body>
</html>
