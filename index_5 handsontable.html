<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Patrick's Compact Drive</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">

    <style>
        :root { --sidebar-width: 250px; --gh-dark: #1f2328; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, sans-serif; }
        
        #header { height: 45px; background: var(--gh-dark); color: white; display: flex; align-items: center; padding: 0 8px; gap: 5px; z-index: 1000; }
        #header input { background: #2d333b; border: 1px solid #444c56; color: white; padding: 4px; border-radius: 4px; width: 60px; flex-grow: 1; font-size: 12px; }
        
        #main-container { display: flex; height: calc(100% - 45px); width: 100%; position: relative; }
        
        /* å´é‚Šæ¬„æ”¹ç‚ºæµ®å‹•ï¼Œä¸å½±éŸ¿è¡¨æ ¼å¯¬åº¦è¨ˆç®— */
        #sidebar { 
            width: var(--sidebar-width); background: #f6f8fa; border-right: 1px solid #d0d7de; 
            display: flex; flex-direction: column; position: absolute; height: 100%; z-index: 999;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        #sidebar.visible { transform: translateX(0); }

        /* è¡¨æ ¼ç¸®æ”¾æ ¸å¿ƒï¼šå¼·è¿«å­—é«”èˆ‡é–“è·è®Šå° */
        .handsontable { font-size: 11px !important; }
        .handsontable th, .handsontable td { padding: 2px 4px !important; height: 22px !important; }

        #grid-wrapper { flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; overflow: hidden; }
        #grid-container { width: 100% !important; height: 100% !important; }

        #tab-bar { height: 35px; background: #eee; border-top: 1px solid #ccc; display: flex; align-items: center; padding: 0 5px; gap: 4px; overflow-x: auto; }
        .tab { padding: 4px 10px; background: #ddd; border-radius: 4px 4px 0 0; cursor: pointer; font-size: 11px; border: 1px solid #ccc; white-space: nowrap; }
        .tab.active { background: #fff; font-weight: bold; }

        .btn { padding: 4px 8px; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; font-size: 12px; }
        #status { font-size: 10px; color: #8b949e; margin-left: auto; max-width: 60px; overflow: hidden; }
        
        /* å…¨è¢å¹•æª¢è¦–åˆ‡æ› */
        .zoom-controls { position: absolute; bottom: 50px; right: 20px; z-index: 1001; display: flex; flex-direction: column; gap: 5px; }
        .zoom-btn { width: 35px; height: 35px; border-radius: 50%; background: #0969da; color: white; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 18px; }
    </style>
</head>
<body>

<div id="header">
    <button class="btn" style="background:#444d56; color:white;" onclick="toggleSidebar()">ğŸ“</button>
    <input type="password" id="token" placeholder="Token">
    <button class="btn" style="background:#2ea44f; color:white;" onclick="connectAndRefresh()">ğŸ”„</button>
    <button class="btn" style="background:#0969da; color:white;" onclick="saveCurrentFile()">ğŸ’¾</button>
    <span id="status">Ready</span>
</div>

<div id="main-container">
    <div id="sidebar">
        <div style="padding:10px; font-weight:bold; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
            <span>Files</span>
            <button class="btn" style="background:#2ea44f; color:white;" onclick="createNewFile()">ï¼‹</button>
        </div>
        <ul id="file-list" style="list-style:none; padding:0; margin:0;"></ul>
    </div>

    <div id="grid-wrapper">
        <div id="grid-container"></div>
        <div id="tab-bar">
            <button class="tab-add" onclick="addNewTab()" style="font-size:11px; padding:2px 6px;">ï¼‹Sheet</button>
        </div>
    </div>
</div>

<div class="zoom-controls">
    <button class="zoom-btn" onclick="fitToWindow()">ğŸ”</button>
</div>

<script>
    const REPO = "patrickwoolf/my-online-drive";
    let currentFileName = null;
    let currentSha = null;
    let hotInstance = null;
    let workbookData = { "Sheet1": [["", "", "", ""], ["", "", "", ""]] };
    let activeSheetName = "Sheet1";

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('visible');
    }

    window.onload = () => {
        const saved = localStorage.getItem('gh_token');
        if (saved) document.getElementById('token').value = saved;
        initGrid(workbookData[activeSheetName]);
        renderTabs();
    };

    function initGrid(data) {
        if (hotInstance) hotInstance.destroy();
        
        hotInstance = new Handsontable(document.getElementById('grid-container'), {
            data: data,
            rowHeaders: true,
            colHeaders: true,
            width: '100%',
            height: '100%',
            stretchH: 'all',        // ã€é—œéµã€‘å°‡æ‰€æœ‰æ¬„ä½æ’æ»¿å¯¬åº¦ï¼Œé”åˆ°ã€Œå…¨éƒ¨éƒ½åœ¨è¦–é‡ä¸­ã€
            autoColumnSize: true,   // è‡ªå‹•è¨ˆç®—æœ€å°å¯¬åº¦
            contextMenu: true,
            outsideClickDeselects: false,
            licenseKey: 'non-commercial-and-evaluation',
            
            // è¡Œå‹•ç«¯é»æ“Šå³è¼¸å…¥ä¿®æ­£
            afterSelection: function() {
                setTimeout(() => {
                    const editor = this.getActiveEditor();
                    if (editor) editor.beginEditing();
                }, 150);
            }
        });
    }

    // å¼·åˆ¶ç¸®å°ä¸¦é©æ‡‰è¢å¹•
    function fitToWindow() {
        if (!hotInstance) return;
        // åˆ‡æ› stretchH æ¨¡å¼ï¼šå¦‚æœåŸæœ¬æ˜¯ all å°±é—œæ‰ï¼Œåä¹‹äº¦ç„¶
        const currentStretch = hotInstance.getSettings().stretchH;
        hotInstance.updateSettings({
            stretchH: currentStretch === 'all' ? 'none' : 'all'
        });
        document.getElementById('status').innerText = currentStretch === 'all' ? "Normal" : "Fit All";
    }

    function renderTabs() {
        const tabBar = document.getElementById('tab-bar');
        tabBar.querySelectorAll('.tab').forEach(t => t.remove());
        Object.keys(workbookData).forEach(name => {
            const btn = document.createElement('div');
            btn.className = `tab ${name === activeSheetName ? 'active' : ''}`;
            btn.innerText = name;
            btn.onclick = () => switchTab(name);
            tabBar.insertBefore(btn, tabBar.firstChild);
        });
    }

    function switchTab(name) {
        workbookData[activeSheetName] = hotInstance.getData();
        activeSheetName = name;
        initGrid(workbookData[name]);
        renderTabs();
    }

    function addNewTab() {
        const name = prompt("Sheet Name:");
        if (!name || workbookData[name]) return;
        workbookData[name] = [["", "", ""], ["", "", ""]];
        switchTab(name);
    }

    // --- GitHub API Functions ---
    async function connectAndRefresh() {
        const token = document.getElementById('token').value;
        if (!token) return alert("Token!");
        localStorage.setItem('gh_token', token);
        try {
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/?t=${Date.now()}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            const data = await res.json();
            const listEl = document.getElementById('file-list');
            listEl.innerHTML = '';
            data.filter(f => f.name.endsWith('.json')).forEach(file => {
                const li = document.createElement('li');
                li.style.cssText = "padding:12px; border-bottom:1px solid #ddd; cursor:pointer; font-size:13px;";
                li.innerHTML = `ğŸ“„ ${file.name}`;
                li.onclick = () => loadFile(file.name);
                listEl.appendChild(li);
            });
            document.getElementById('status').innerText = "Sync OK";
        } catch(e) { alert(e.message); }
    }

    async function loadFile(name) {
        document.getElementById('status').innerText = `Loading...`;
        toggleSidebar();
        try {
            const token = document.getElementById('token').value;
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${name}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            const file = await res.json();
            currentFileName = name;
            currentSha = file.sha;
            const binaryString = atob(file.content);
            const binData = new Uint8Array(binaryString.split('').map(x => x.charCodeAt(0)));
            let jsonData;
            try { jsonData = JSON.parse(pako.ungzip(binData, { to: 'string' })); }
            catch (err) { jsonData = JSON.parse(decodeURIComponent(escape(binaryString))); }
            workbookData = Array.isArray(jsonData) ? { "Sheet1": jsonData } : jsonData;
            activeSheetName = Object.keys(workbookData)[0];
            initGrid(workbookData[activeSheetName]);
            renderTabs();
            document.getElementById('status').innerText = "Loaded";
        } catch (e) { alert(e.message); }
    }

    async function saveCurrentFile() {
        if (!currentFileName) return alert("Open file first");
        workbookData[activeSheetName] = hotInstance.getData();
        document.getElementById('status').innerText = "Saving...";
        try {
            const token = document.getElementById('token').value;
            const compressed = pako.gzip(JSON.stringify(workbookData));
            const content = btoa(String.fromCharCode.apply(null, compressed));
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${currentFileName}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Save", content, sha: currentSha })
            });
            const result = await res.json();
            currentSha = result.content.sha;
            document.getElementById('status').innerText = "ğŸš€ Saved";
        } catch (e) { alert(e.message); }
    }

    async function createNewFile() {
        let name = prompt("Filename:");
        if (!name) return;
        if (!name.endsWith('.json')) name += '.json';
        const token = document.getElementById('token').value;
        const compressed = pako.gzip(JSON.stringify({ "Sheet1": [["",""],["",""]] }));
        await fetch(`https://api.github.com/repos/${REPO}/contents/${name}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Create", content: btoa(String.fromCharCode.apply(null, compressed)) })
        });
        connectAndRefresh();
    }
</script>
</body>
</html>
