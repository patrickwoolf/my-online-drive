<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Simple Drive V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root { --primary: #0969da; --success: #2ea44f; --danger: #cf222e; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f6f8fa; color: #1f2328; }
        
        /* å›ºå®šæ¨™é¡Œæ¬„ */
        #header { background: #24292f; color: white; padding: 8px; display: flex; gap: 8px; align-items: center; position: sticky; top: 0; z-index: 100; font-size: 13px; }
        #header input { background: #333; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; width: 60px; flex-grow: 1; }
        
        /* æ“ä½œå·¥å…·åˆ— */
        #toolbar { background: #fff; border-bottom: 1px solid #d0d7de; padding: 8px; display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; align-items: center; }
        .btn { padding: 6px 10px; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; background: #f6f8fa; font-size: 12px; font-weight: 600; }
        .btn:active { background: #ebecf0; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-danger { color: var(--danger); }

        /* åˆ†é æ¨™ç±¤ */
        #tab-bar { background: #f6f8fa; display: flex; border-bottom: 1px solid #d0d7de; overflow-x: auto; }
        .tab { padding: 8px 16px; border-right: 1px solid #d0d7de; cursor: pointer; font-size: 12px; background: #eaeef2; }
        .tab.active { background: #fff; border-bottom: 2px solid var(--primary); font-weight: bold; }
        .tab-add { padding: 8px 12px; cursor: pointer; color: var(--success); font-weight: bold; }

        /* è¡¨æ ¼å€åŸŸ */
        #editor-container { padding: 20px; overflow: auto; height: calc(100vh - 180px); position: relative; }
        table { border-collapse: collapse; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transform-origin: top left; transition: transform 0.1s ease; }
        td, th { border: 1px solid #d0d7de; padding: 6px; min-width: 60px; min-height: 25px; font-size: 14px; outline: none; }
        th { background: #f6f8fa; font-size: 11px; color: #57606a; position: relative; }
        td:focus { background: #f0f7ff; box-shadow: inset 0 0 0 2px var(--primary); }

        /* å´é‚Šæ¬„ */
        #file-list { position: fixed; left: 0; top: 0; width: 260px; height: 100%; background: white; transform: translateX(-100%); transition: 0.3s; z-index: 200; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        #file-list.open { transform: translateX(0); }
        .file-item { padding: 12px 20px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div id="header">
    <button class="btn" style="background:transparent; color:white; border:1px solid #666;" onclick="toggleSidebar()">ğŸ“</button>
    <input type="password" id="token" placeholder="GitHub Token">
    <button class="btn btn-primary" onclick="fetchFiles()">ğŸ”„</button>
    <button class="btn" style="background:var(--success); color:white; border:none;" onclick="manualSave()">ğŸ’¾ Save</button>
    <span id="status">Ready</span>
</div>

<div id="file-list">
    <div style="padding:15px; font-weight:bold; border-bottom:1px solid #ddd; background:#f6f8fa;">My Cloud Files <button onclick="createNewFile()" style="float:right">+</button></div>
    <div id="file-items"></div>
</div>

<div id="toolbar">
    <div style="display:flex; align-items:center; gap:4px; border-right:1px solid #ddd; padding-right:8px;">
        <button class="btn" onclick="insertRow()">ï¼‹è¡Œ</button>
        <button class="btn btn-danger" onclick="deleteRow()">ï¼è¡Œ</button>
    </div>
    <div style="display:flex; align-items:center; gap:4px; border-right:1px solid #ddd; padding-right:8px;">
        <button class="btn" onclick="insertCol()">ï¼‹åˆ—</button>
        <button class="btn btn-danger" onclick="deleteCol()">ï¼åˆ—</button>
    </div>
    <div style="display:flex; align-items:center; gap:4px;">
        <button class="btn" onclick="setZoom(0.1)">10%</button>
        <button class="btn" onclick="setZoom(0.5)">50%</button>
        <button class="btn" onclick="setZoom(1)">100%</button>
        <button class="btn" onclick="setZoom(2)">200%</button>
    </div>
</div>

<div id="tab-bar">
    <div class="tab-add" onclick="addNewSheet()">ï¼‹</div>
</div>

<div id="editor-container">
    <table id="main-table"></table>
</div>

<script>
    const REPO = "patrickwoolf/my-online-drive";
    let workbook = { "Sheet1": [["", "", ""], ["", "", ""]] };
    let activeSheet = "Sheet1";
    let currentFile = null;
    let currentSha = null;
    let currentZoom = 1;
    let lastSavedData = "";

    window.onload = () => {
        const saved = localStorage.getItem('gh_token');
        if (saved) { document.getElementById('token').value = saved; fetchFiles(); }
        renderTabs();
        initTable();
        // æ¯ 30 ç§’è‡ªå‹•æª¢æŸ¥ä¸¦å„²å­˜
        setInterval(autoSave, 30000);
    };

    function toggleSidebar() { document.getElementById('file-list').classList.toggle('open'); }

    // --- è¡¨æ ¼æ¸²æŸ“æ ¸å¿ƒ ---
    function initTable() {
        const data = workbook[activeSheet];
        const table = document.getElementById('main-table');
        table.innerHTML = "";

        // ç”Ÿæˆæ¬„é ­ (A, B, C...)
        const thead = document.createElement('tr');
        thead.appendChild(document.createElement('th')); // å·¦ä¸Šè§’ç©ºç™½
        for(let i=0; i<data[0].length; i++) {
            const th = document.createElement('th');
            th.innerText = String.fromCharCode(65 + i);
            thead.appendChild(th);
        }
        table.appendChild(thead);

        // ç”Ÿæˆè³‡æ–™è¡Œ
        data.forEach((rowData, r) => {
            const tr = document.createElement('tr');
            const th = document.createElement('th');
            th.innerText = r + 1;
            tr.appendChild(th);

            rowData.forEach((cellData, c) => {
                const td = document.createElement('td');
                td.contentEditable = "true";
                td.innerText = cellData;
                // å¤±å»ç„¦é»æ™‚å³æ™‚æ›´æ–°å…§å­˜æ•¸æ“š
                td.onblur = () => { workbook[activeSheet][r][c] = td.innerText; };
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
    }

    // --- å¤šåˆ†é åŠŸèƒ½ ---
    function renderTabs() {
        const tabBar = document.getElementById('tab-bar');
        tabBar.querySelectorAll('.tab').forEach(t => t.remove());
        Object.keys(workbook).forEach(name => {
            const div = document.createElement('div');
            div.className = `tab ${name === activeSheet ? 'active' : ''}`;
            div.innerText = name;
            div.onclick = () => { activeSheet = name; renderTabs(); initTable(); };
            tabBar.insertBefore(div, tabBar.firstChild);
        });
    }

    function addNewSheet() {
        const name = prompt("åˆ†é åç¨±:", "Sheet" + (Object.keys(workbook).length + 1));
        if (name && !workbook[name]) {
            workbook[name] = [["", "", ""], ["", "", ""]];
            activeSheet = name;
            renderTabs();
            initTable();
        }
    }

    // --- è¡Œåˆ—å¢åˆª (åœ¨ç›®å‰ç„¦é»ä½ç½®æ’å…¥) ---
    function getFocus() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return null;
        const td = sel.anchorNode.parentElement;
        if (td.tagName !== 'TD') return null;
        return { r: td.parentElement.rowIndex - 1, c: td.cellIndex - 1 };
    }

    function insertRow() {
        const focus = getFocus() || { r: workbook[activeSheet].length, c: 0 };
        const newRow = new Array(workbook[activeSheet][0].length).fill("");
        workbook[activeSheet].splice(focus.r, 0, newRow);
        initTable();
    }

    function deleteRow() {
        const focus = getFocus();
        if (focus && workbook[activeSheet].length > 1) {
            workbook[activeSheet].splice(focus.r, 1);
            initTable();
        }
    }

    function insertCol() {
        const focus = getFocus() || { r: 0, c: workbook[activeSheet][0].length };
        workbook[activeSheet].forEach(row => row.splice(focus.c, 0, ""));
        initTable();
    }

    function deleteCol() {
        const focus = getFocus();
        if (focus && workbook[activeSheet][0].length > 1) {
            workbook[activeSheet].forEach(row => row.splice(focus.c, 1));
            initTable();
        }
    }

    // --- ç¸®æ”¾åŠŸèƒ½ ---
    function setZoom(level) {
        currentZoom = level;
        document.getElementById('main-table').style.transform = `scale(${level})`;
        document.getElementById('status').innerText = `Zoom: ${Math.round(level*100)}%`;
    }

    // --- GitHub API & å„²å­˜ ---
    async function manualSave() {
        if (!currentFile) return alert("è«‹å…ˆé–‹å•Ÿæª”æ¡ˆ");
        await saveToCloud();
        document.getElementById('status').innerText = "å·²æ‰‹å‹•å„²å­˜";
    }

    async function autoSave() {
        const currentDataStr = JSON.stringify(workbook);
        if (currentFile && currentDataStr !== lastSavedData) {
            document.getElementById('status').innerText = "è‡ªå‹•å„²å­˜ä¸­...";
            await saveToCloud();
            document.getElementById('status').innerText = "è‡ªå‹•å„²å­˜å®Œæˆ";
        }
    }

    async function saveToCloud() {
        try {
            const dataStr = JSON.stringify(workbook);
            const compressed = pako.gzip(dataStr);
            const base64 = btoa(String.fromCharCode.apply(null, compressed));
            const token = document.getElementById('token').value;
            
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${currentFile}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "AutoSave", content: base64, sha: currentSha })
            });
            const json = await res.json();
            currentSha = json.content.sha;
            lastSavedData = dataStr;
        } catch (e) { console.error("Save failed", e); }
    }

    async function fetchFiles() {
        const token = document.getElementById('token').value;
        localStorage.setItem('gh_token', token);
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/`, {
            headers: { 'Authorization': `token ${token}` }
        });
        const files = await res.json();
        const list = document.getElementById('file-items');
        list.innerHTML = "";
        files.filter(f => f.name.endsWith('.json')).forEach(f => {
            const div = document.createElement('div');
            div.className = "file-item";
            div.innerHTML = `<span>ğŸ“„ ${f.name}</span>`;
            div.onclick = () => loadFile(f.name);
            list.appendChild(div);
        });
    }

    async function loadFile(name) {
        toggleSidebar();
        document.getElementById('status').innerText = "Loading...";
        const token = document.getElementById('token').value;
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${name}`, {
            headers: { 'Authorization': `token ${token}` }
        });
        const json = await res.json();
        currentFile = name;
        currentSha = json.sha;
        const content = JSON.parse(pako.ungzip(new Uint8Array(atob(json.content).split('').map(c => c.charCodeAt(0))), {to:'string'}));
        workbook = Array.isArray(content) ? { "Sheet1": content } : content;
        activeSheet = Object.keys(workbook)[0];
        lastSavedData = JSON.stringify(workbook);
        renderTabs();
        initTable();
        document.getElementById('status').innerText = name;
    }

    async function createNewFile() {
        let name = prompt("æª”å:");
        if (!name) return;
        if (!name.endsWith('.json')) name += '.json';
        currentFile = name;
        workbook = { "Sheet1": [["","",""],["","",""]] };
        await saveToCloud();
        fetchFiles();
    }
</script>
</body>
</html>
