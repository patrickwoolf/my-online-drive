<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrick's Simple Drive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; }
        #header { background: #333; color: white; padding: 10px; display: flex; gap: 5px; align-items: center; position: sticky; top: 0; z-index: 10; }
        #header input { background: #444; border: 1px solid #555; color: white; padding: 5px; width: 60px; flex-grow: 1; }
        
        /* æ ¸å¿ƒè¡¨æ ¼æ¨£å¼ */
        #editor-container { padding: 10px; overflow: auto; height: calc(100vh - 120px); }
        table { border-collapse: collapse; background: white; width: 100%; min-width: 600px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; word-break: break-all; }
        th { background: #eee; width: 40px; }
        td:focus { outline: 2px solid #0969da; background: #f0f7ff; }

        #toolbar { background: #ddd; padding: 10px; display: flex; gap: 10px; overflow-x: auto; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        .save-btn { background: #0969da; color: white; }
        .add-btn { background: #2ea44f; color: white; }
        
        #file-list { position: fixed; left: 0; top: 0; width: 250px; height: 100%; background: white; transform: translateX(-100%); transition: 0.3s; z-index: 100; box-shadow: 2px 0 5px rgba(0,0,0,0.2); padding-top: 50px; }
        #file-list.open { transform: translateX(0); }
        .file-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
    </style>
</head>
<body>

<div id="header">
    <button class="btn" onclick="document.getElementById('file-list').classList.toggle('open')">ğŸ“</button>
    <input type="password" id="token" placeholder="Token">
    <button class="btn" onclick="fetchFiles()">ğŸ”„</button>
    <button class="btn save-btn" onclick="saveFile()">ğŸ’¾ Save</button>
    <span id="status" style="font-size:12px">Ready</span>
</div>

<div id="file-list"></div>

<div id="toolbar">
    <button class="btn add-btn" onclick="addRow()">ï¼‹ Row</button>
    <button class="btn add-btn" onclick="addCol()">ï¼‹ Col</button>
    <button class="btn" onclick="adjustZoom(0.8)">ğŸ” ç¸®å°</button>
    <button class="btn" onclick="adjustZoom(1)">ğŸ” é‚„åŸ</button>
</div>

<div id="editor-container">
    <table id="main-table"></table>
</div>

<script>
    const REPO = "patrickwoolf/my-online-drive";
    let currentFile = null;
    let currentSha = null;
    let tableZoom = 1;

    window.onload = () => {
        const saved = localStorage.getItem('gh_token');
        if (saved) {
            document.getElementById('token').value = saved;
            fetchFiles();
        }
        initTable([["","",""],["","",""]]);
    };

    // åˆå§‹åŒ–è¡¨æ ¼ï¼šä½¿ç”¨ contenteditable è®“å–®å…ƒæ ¼å¯ç·¨è¼¯
    function initTable(data) {
        const table = document.getElementById('main-table');
        table.innerHTML = "";
        data.forEach((rowData, r) => {
            const tr = document.createElement('tr');
            rowData.forEach((cellData, c) => {
                const td = document.createElement('td');
                td.contentEditable = "true";
                td.innerText = cellData;
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
    }

    // è®€å–è¡¨æ ¼æ•¸æ“š
    function getTableData() {
        return Array.from(document.querySelectorAll('tr')).map(tr => 
            Array.from(tr.querySelectorAll('td')).map(td => td.innerText)
        );
    }

    function addRow() {
        const table = document.getElementById('main-table');
        const cols = table.rows[0]?.cells.length || 3;
        const tr = document.createElement('tr');
        for(let i=0; i<cols; i++) {
            const td = document.createElement('td');
            td.contentEditable = "true";
            tr.appendChild(td);
        }
        table.appendChild(tr);
    }

    function addCol() {
        const rows = document.querySelectorAll('tr');
        rows.forEach(tr => {
            const td = document.createElement('td');
            td.contentEditable = "true";
            tr.appendChild(td);
        });
    }

    function adjustZoom(level) {
        document.getElementById('main-table').style.transform = `scale(${level})`;
        document.getElementById('main-table').style.transformOrigin = "top left";
    }

    // --- GitHub ä¸²æ¥ ---
    async function fetchFiles() {
        const token = document.getElementById('token').value;
        localStorage.setItem('gh_token', token);
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/`, {
            headers: { 'Authorization': `token ${token}` }
        });
        const files = await res.json();
        const list = document.getElementById('file-list');
        list.innerHTML = "";
        files.filter(f => f.name.endsWith('.json')).forEach(f => {
            const div = document.createElement('div');
            div.className = "file-item";
            div.innerText = f.name;
            div.onclick = () => loadFile(f.name);
            list.appendChild(div);
        });
    }

    async function loadFile(name) {
        document.getElementById('file-list').classList.remove('open');
        document.getElementById('status').innerText = "Loading...";
        const token = document.getElementById('token').value;
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${name}`, {
            headers: { 'Authorization': `token ${token}` }
        });
        const json = await res.json();
        currentFile = name;
        currentSha = json.sha;
        
        const content = JSON.parse(pako.ungzip(new Uint8Array(atob(json.content).split('').map(c => c.charCodeAt(0))), {to:'string'}));
        // å¦‚æœæ˜¯èˆŠçš„å¤šåˆ†é æ ¼å¼ï¼Œé€™è£¡ç°¡åŒ–å–ç¬¬ä¸€é 
        const data = Array.isArray(content) ? content : Object.values(content)[0];
        initTable(data);
        document.getElementById('status').innerText = name;
    }

    async function saveFile() {
        if(!currentFile) return alert("No file opened");
        document.getElementById('status').innerText = "Saving...";
        const data = getTableData();
        const compressed = pako.gzip(JSON.stringify(data));
        const base64 = btoa(String.fromCharCode.apply(null, compressed));
        
        const token = document.getElementById('token').value;
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${currentFile}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Save", content: base64, sha: currentSha })
        });
        const resJson = await res.json();
        currentSha = resJson.content.sha;
        document.getElementById('status').innerText = "Saved!";
    }
</script>

</body>
</html>
