<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Drive V18</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #0969da; --success: #2ea44f; --danger: #cf222e; --gh-dark: #24292f; --select-bg: #e7f3ff; --select-border: #0969da; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f6f8fa; overflow: hidden; user-select: none; }
        #header { background: var(--gh-dark); color: white; padding: 8px 12px; display: flex; gap: 10px; align-items: center; height: 45px; box-sizing: border-box; z-index: 300; position: relative; }
        #header input { background: #333; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; width: 80px; flex-grow: 1; }
        #toolbar { background: #fff; border-bottom: 1px solid #d0d7de; padding: 8px; display: flex; gap: 5px; align-items: center; overflow-x: auto; position: relative; z-index: 10; flex-wrap: nowrap; }
        .btn { padding: 6px 10px; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; background: #f6f8fa; font-size: 12px; font-weight: 600; white-space: nowrap; }
        .btn:active { opacity: 0.7; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-group { display: flex; gap: 2px; border-right: 1px solid #ddd; padding-right: 5px; margin-right: 5px; flex-shrink: 0; }
        .group-label { font-size: 10px; color: #666; margin-bottom: 2px; display: block; text-align: center; }
        #sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100%; background: white; transform: translateX(-100%); transition: 0.3s; z-index: 1000; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 999; display: none; }
        #tab-bar { background: #f6f8fa; display: flex; border-bottom: 1px solid #d0d7de; overflow-x: auto; height: 35px; }
        .tab { padding: 8px 15px; border-right: 1px solid #d0d7de; cursor: pointer; font-size: 11px; background: #eaeef2; white-space: nowrap; }
        .tab.active { background: #fff; border-bottom: 2px solid var(--primary); font-weight: bold; }
        #editor-container { padding: 20px; overflow: auto; height: calc(100vh - 125px); position: relative; }
        table { border-collapse: collapse; background: white; transform-origin: top left; transition: transform 0.1s; table-layout: fixed; }
        td, th { border: 1px solid #d0d7de; padding: 4px 8px; font-size: 14px; outline: none; box-sizing: border-box; overflow: hidden; word-break: break-all; white-space: pre-wrap; line-height: 1.2; }
        th { background: #f6f8fa; font-size: 11px; color: #57606a; text-align: center; }
        td.selected { background: var(--select-bg) !important; outline: 1px solid var(--select-border); z-index: 2; }
        #import-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 20px; z-index: 2000; box-shadow: 0 5px 30px rgba(0,0,0,0.3); display: none; width: 400px; }
        #import-modal textarea { width: 100%; height: 200px; margin: 10px 0; font-family: monospace; font-size: 12px; }
        .zoom-info { font-family: monospace; font-size: 13px; min-width: 45px; text-align: center; }
    </style>
</head>
<body>

<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="import-modal">
    <div style="font-weight:bold; margin-bottom:10px;">Excel è²¼ä¸ŠåŠ©æ‰‹</div>
    <textarea id="import-area" placeholder="åœ¨æ­¤è²¼ä¸Šå…§å®¹..."></textarea>
    <div style="text-align:right; gap:10px; display:flex; justify-content: flex-end;">
        <button class="btn" onclick="closeImport()">å–æ¶ˆ</button>
        <button class="btn" style="background:var(--primary); color:white;" onclick="processExcelImport()">ç¢ºèªåŒ¯å…¥</button>
    </div>
</div>

<div id="header">
    <button class="btn" style="background:transparent; color:white;" onclick="toggleSidebar()">ğŸ“</button>
    <input type="password" id="token" placeholder="Token">
    <button class="btn" style="background:var(--primary); color:white; border:none;" onclick="fetchFiles()">Sync</button>
    <button class="btn" style="background:var(--success); color:white; border:none;" onclick="manualSave()">Save</button>
    <span id="status" style="font-size:11px; margin-left:auto;">Ready</span>
</div>

<div id="sidebar">
    <div style="padding:15px; font-weight:bold; background:#f6f8fa; border-bottom:1px solid #ddd;">Cloud Files <button onclick="createNewFile()" style="float:right">+</button></div>
    <div id="file-items"></div>
</div>

<div id="toolbar">
    <div class="btn-group">
        <div><span class="group-label">æ­·å²</span>
            <button class="btn" id="undoBtn" onclick="undo()">â†©ï¸</button>
            <button class="btn" id="redoBtn" onclick="redo()">â†ªï¸</button>
        </div>
    </div>
    <div class="btn-group">
        <div><span class="group-label">ç·¨è¼¯</span>
            <button class="btn" onclick="modifyTable('row', 'before')">è¡Œâ†‘</button>
            <button class="btn" onclick="modifyTable('row', 'after')">è¡Œâ†“</button>
            <button class="btn" onclick="modifyTable('col', 'before')">â†åˆ—</button>
            <button class="btn" onclick="modifyTable('col', 'after')">åˆ—â†’</button>
        </div>
    </div>
    <div class="btn-group">
        <div><span class="group-label">å¯¬é«˜èª¿æ•´ (Â±10%)</span>
            <button class="btn" onclick="resizeSelection('row', 1.1)">é«˜+</button>
            <button class="btn" onclick="resizeSelection('row', 0.9)">é«˜-</button>
            <button class="btn" onclick="resizeSelection('col', 1.1)">å¯¬+</button>
            <button class="btn" onclick="resizeSelection('col', 0.9)">å¯¬-</button>
            <button class="btn" onclick="autoFitSelection()" style="background:#fff7e6; color:#d46b08;">âœ¨è‡ªå‹•é©æ‡‰</button>
        </div>
    </div>
    <div class="btn-group">
        <div><span class="group-label">å·¥å…·</span>
            <button class="btn" onclick="openImport()" style="background:#eef;">ğŸ“‹ From Excel</button>
            <button class="btn" onclick="exportToExcel()" style="background:#1d6f42; color:white;">ğŸ“¥ To Excel</button>
        </div>
    </div>
    <div class="btn-group">
        <div><span class="group-label">ç¸®æ”¾</span>
            <button class="btn" onclick="changeZoom(-0.1)">â–</button>
            <span class="zoom-info" id="zoom-text">100%</span>
            <button class="btn" onclick="changeZoom(0.1)">â•</button>
        </div>
    </div>
</div>

<div id="tab-bar"><div class="tab-add" onclick="addNewSheet()" style="padding:8px; cursor:pointer; color:green;">ï¼‹</div></div>

<div id="editor-container">
    <table id="main-table"></table>
</div>

<script>
    const REPO = "patrickwoolf/my-online-drive";
    let workbook = { "Sheet1": { data: [["","",""]], rowH: [35], colW: [100,100,100] } };
    let activeSheet = "Sheet1";
    let currentFile = null, currentSha = null, currentZoom = 1.0, lastSavedData = "";
    let undoStack = [], redoStack = [];
    let isSelecting = false, startCell = null, endCell = null;

    window.onload = () => {
        const saved = localStorage.getItem('gh_token');
        if (saved) { document.getElementById('token').value = saved; fetchFiles(); }
        initTable();
        setInterval(autoSave, 30000);
        window.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
            if (e.key === 'Delete' || e.key === 'Backspace') { if (document.activeElement.tagName !== 'TD') clearSelectedCells(); }
        });
        document.addEventListener('mouseup', () => { isSelecting = false; });
    };

    // --- æ ¸å¿ƒé‚è¼¯ï¼šå¯¬é«˜èª¿æ•´ (Â±10%) ---
    function resizeSelection(type, factor) {
        const range = getSelectedRange() || (getFocus() ? {rMin: getFocus().r, rMax: getFocus().r, cMin: getFocus().c, cMax: getFocus().c} : null);
        if (!range) return;
        const sheet = workbook[activeSheet];
        
        if (type === 'row') {
            for (let i = range.rMin; i <= range.rMax; i++) {
                let currentH = sheet.rowH[i] || 35;
                sheet.rowH[i] = Math.max(24, Math.round(currentH * factor));
            }
        } else {
            for (let i = range.cMin; i <= range.cMax; i++) {
                let currentW = sheet.colW[i] || 100;
                sheet.colW[i] = Math.max(24, Math.round(currentW * factor));
            }
        }
        renderStyles();
    }

    // --- è‡ªå‹•é©æ‡‰å…§å®¹ (Auto Fit) ---
    function autoFitSelection() {
        const range = getSelectedRange();
        if (!range) return;
        const sheet = workbook[activeSheet];
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        context.font = "14px -apple-system, sans-serif";

        // èª¿æ•´å¯¬åº¦
        for (let c = range.cMin; c <= range.cMax; c++) {
            let maxW = 24;
            for (let r = 0; r < sheet.data.length; r++) {
                const text = sheet.data[r][c] || "";
                const metrics = context.measureText(text);
                maxW = Math.max(maxW, metrics.width + 20); // åŠ ä¸Š padding
            }
            sheet.colW[c] = Math.ceil(maxW);
        }

        // èª¿æ•´é«˜åº¦ (ç²—ç•¥ä¼°è¨ˆ)
        for (let r = range.rMin; r <= range.rMax; r++) {
            let maxH = 24;
            sheet.data[r].forEach(text => {
                const lines = (text || "").split('\n').length;
                maxH = Math.max(maxH, lines * 20 + 10);
            });
            sheet.rowH[r] = Math.ceil(maxH);
        }
        renderStyles();
    }

    // --- åŸºç¤è¡¨æ ¼èˆ‡ UI ---
    function initTable() {
        const sheet = workbook[activeSheet];
        const table = document.getElementById('main-table');
        table.innerHTML = "";
        const thead = document.createElement('tr');
        thead.appendChild(document.createElement('th'));
        for(let i=0; i<sheet.data[0].length; i++) {
            const th = document.createElement('th'); th.innerText = String.fromCharCode(65 + i);
            thead.appendChild(th);
        }
        table.appendChild(thead);
        sheet.data.forEach((rowData, r) => {
            const tr = document.createElement('tr');
            const th = document.createElement('th'); th.innerText = r + 1;
            tr.appendChild(th);
            rowData.forEach((cellData, c) => {
                const td = document.createElement('td');
                td.contentEditable = "true"; td.innerText = cellData;
                td.dataset.r = r; td.dataset.c = c;
                td.onmousedown = (e) => { isSelecting = true; startCell = {r, c}; endCell = {r, c}; highlightRange(); };
                td.onmouseover = () => { if(isSelecting) { endCell = {r, c}; highlightRange(); } };
                td.onblur = () => { if(sheet.data[r][c] !== td.innerText) { pushHistory(); sheet.data[r][c] = td.innerText; } };
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
        renderStyles();
        renderTabs();
    }

    function renderStyles() {
        const sheet = workbook[activeSheet];
        const tableRows = document.getElementById('main-table').rows;
        if(!tableRows.length) return;
        // åˆ—å¯¬
        for (let j = 0; j < sheet.data[0].length; j++) {
            const w = (sheet.colW[j] || 100) + 'px';
            for (let i = 0; i < tableRows.length; i++) {
                const cell = tableRows[i].cells[j+1];
                if (cell) { cell.style.width = w; cell.style.minWidth = w; cell.style.maxWidth = w; }
            }
        }
        // è¡Œé«˜
        for (let i = 0; i < sheet.data.length; i++) {
            const h = (sheet.rowH[i] || 35) + 'px';
            const row = tableRows[i+1];
            if (row) Array.from(row.cells).forEach(c => c.style.height = h);
        }
    }

    function getSelectedRange() {
        const selected = document.querySelectorAll('td.selected');
        if (!selected.length) return null;
        let rMin = 999, rMax = 0, cMin = 999, cMax = 0;
        selected.forEach(td => {
            const r = parseInt(td.dataset.r), c = parseInt(td.dataset.c);
            rMin = Math.min(rMin, r); rMax = Math.max(rMax, r);
            cMin = Math.min(cMin, c); cMax = Math.max(cMax, c);
        });
        return { rMin, rMax, cMin, cMax };
    }

    function getFocus() {
        const sel = window.getSelection();
        if (!sel || !sel.rangeCount) return null;
        let node = sel.anchorNode;
        while (node && node.tagName !== 'TD') node = node.parentElement;
        return node ? { r: parseInt(node.dataset.r), c: parseInt(node.dataset.c) } : null;
    }

    function highlightRange() {
        if(!startCell || !endCell) return;
        const rMin = Math.min(startCell.r, endCell.r), rMax = Math.max(startCell.r, endCell.r);
        const cMin = Math.min(startCell.c, endCell.c), cMax = Math.max(startCell.c, endCell.c);
        document.querySelectorAll('td').forEach(td => {
            const r = parseInt(td.dataset.r), c = parseInt(td.dataset.c);
            td.classList.toggle('selected', r >= rMin && r <= rMax && c >= cMin && c <= cMax);
        });
    }

    // --- æ•¸æ“šåŒ¯å…¥èˆ‡å…¶å®ƒè¼”åŠ© ---
    function openImport() { document.getElementById('import-modal').style.display = 'block'; document.getElementById('import-area').focus(); }
    function closeImport() { document.getElementById('import-modal').style.display = 'none'; }
    function processExcelImport() {
        const text = document.getElementById('import-area').value; if (!text) return closeImport();
        const focus = getFocus() || {r:0, c:0}; pushHistory();
        const rows = text.split(/\r\n|\n/).map(row => row.split('\t'));
        let sheet = workbook[activeSheet];
        rows.forEach((rowData, rIdx) => {
            const tr = focus.r + rIdx;
            if (tr >= sheet.data.length) { sheet.data.push(new Array(sheet.data[0].length).fill("")); sheet.rowH.push(35); }
            rowData.forEach((val, cIdx) => {
                const tc = focus.c + cIdx;
                if (tc >= sheet.data[0].length) { sheet.data.forEach(r => r.push("")); sheet.colW.push(100); }
                sheet.data[tr][tc] = val;
            });
        });
        initTable(); closeImport();
    }

    function undo() { if (undoStack.length) { redoStack.push(JSON.stringify(workbook)); workbook = JSON.parse(undoStack.pop()); initTable(); updateHistoryButtons(); } }
    function redo() { if (redoStack.length) { undoStack.push(JSON.stringify(workbook)); workbook = JSON.parse(redoStack.pop()); initTable(); updateHistoryButtons(); } }
    function pushHistory() { undoStack.push(JSON.stringify(workbook)); redoStack = []; if (undoStack.length > 50) undoStack.shift(); updateHistoryButtons(); }
    function updateHistoryButtons() { document.getElementById('undoBtn').disabled = !undoStack.length; document.getElementById('redoBtn').disabled = !redoStack.length; }
    function exportToExcel() { const wb = XLSX.utils.book_new(); Object.keys(workbook).forEach(name => XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(workbook[name].data), name)); XLSX.writeFile(wb, currentFile ? currentFile.replace('.json', '.xlsx') : 'export.xlsx'); }
    function modifyTable(type, action) { pushHistory(); const f = getFocus() || {r:0, c:0}; let sheet = workbook[activeSheet]; if (type === 'row') { const pos = action === 'before' ? f.r : f.r + 1; sheet.data.splice(pos, 0, new Array(sheet.data[0].length).fill("")); sheet.rowH.splice(pos, 0, 35); } else { const pos = action === 'before' ? f.c : f.c + 1; sheet.data.forEach(r => r.splice(pos, 0, "")); sheet.colW.splice(pos, 0, 100); } initTable(); }
    function changeZoom(delta) { currentZoom = Math.max(0.1, Math.min(3, currentZoom + delta)); document.getElementById('main-table').style.transform = `scale(${currentZoom})`; document.getElementById('zoom-text').innerText = Math.round(currentZoom*100)+"%"; }
    function toggleSidebar() { const open = document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').style.display = open ? 'block' : 'none'; }
    function renderTabs() { const bar = document.getElementById('tab-bar'); bar.querySelectorAll('.tab').forEach(t => t.remove()); Object.keys(workbook).forEach(name => { const div = document.createElement('div'); div.className = `tab ${name === activeSheet ? 'active' : ''}`; div.innerText = name; div.onclick = () => { activeSheet = name; initTable(); }; bar.insertBefore(div, bar.firstChild); }); }
    async function fetchFiles() { const token = document.getElementById('token').value; if(!token) return; localStorage.setItem('gh_token', token); const res = await fetch(`https://api.github.com/repos/${REPO}/contents/`, { headers: { 'Authorization': `token ${token}` } }); const files = await res.json(); const list = document.getElementById('file-items'); list.innerHTML = ""; files.filter(f => f.name.endsWith('.json')).forEach(f => { const d = document.createElement('div'); d.className = "file-item"; d.innerText = f.name; d.onclick = () => loadFile(f.name); list.appendChild(d); }); }
    async function loadFile(name) { toggleSidebar(); document.getElementById('status').innerText = "Loading..."; const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${name}`, { headers: { 'Authorization': `token ${document.getElementById('token').value}` } }); const json = await res.json(); currentFile = name; currentSha = json.sha; const content = JSON.parse(pako.ungzip(new Uint8Array(atob(json.content).split('').map(c => c.charCodeAt(0))), {to:'string'})); workbook = content; activeSheet = Object.keys(workbook)[0]; lastSavedData = JSON.stringify(workbook); initTable(); document.getElementById('status').innerText = name; }
    async function saveToCloud() { const dataStr = JSON.stringify(workbook); const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${currentFile}`, { method: 'PUT', headers: { 'Authorization': `token ${document.getElementById('token').value}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: "AutoSave", content: btoa(String.fromCharCode.apply(null, pako.gzip(dataStr))), sha: currentSha }) }); const json = await res.json(); if(json.content) { currentSha = json.content.sha; lastSavedData = dataStr; } }
    async function autoSave() { if (currentFile && JSON.stringify(workbook) !== lastSavedData) { document.getElementById('status').innerText = "Saving..."; await saveToCloud(); document.getElementById('status').innerText = currentFile; } }
    function manualSave() { if(currentFile) saveToCloud(); }
    function addNewSheet() { const name = prompt("åˆ†é åç¨±:"); if (name && !workbook[name]) { pushHistory(); workbook[name] = { data: [["",""]], rowH: [35], colW: [100,100] }; activeSheet = name; initTable(); } }
    function createNewFile() { let name = prompt("æ–°æª”å:"); if (!name) return; if (!name.endsWith('.json')) name += '.json'; currentFile = name; workbook = { "Sheet1": { data: [["",""]], rowH:[35], colW:[100,100] } }; saveToCloud().then(fetchFiles); }
</script>
</body>
</html>
