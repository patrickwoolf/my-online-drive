<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Drive V21</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #0969da; --success: #2ea44f; --danger: #cf222e; --gh-dark: #24292f; --select-bg: #e7f3ff; --select-border: #0969da; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f6f8fa; overflow: hidden; user-select: none; }
        #header { background: var(--gh-dark); color: white; padding: 8px 12px; display: flex; gap: 10px; align-items: center; height: 45px; box-sizing: border-box; z-index: 300; position: relative; }
        #header input { background: #333; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; width: 80px; flex-grow: 1; }
        #toolbar { background: #fff; border-bottom: 1px solid #d0d7de; padding: 8px; display: flex; gap: 5px; align-items: center; overflow-x: auto; position: relative; z-index: 10; flex-wrap: nowrap; height: 80px; box-sizing: border-box; }
        .btn { padding: 4px 8px; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; background: #f6f8fa; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .btn:active { opacity: 0.7; }
        .btn-group { display: flex; gap: 3px; border-right: 1px solid #ddd; padding-right: 8px; margin-right: 5px; flex-shrink: 0; flex-direction: column; height: 100%; justify-content: center; }
        .group-row { display: flex; gap: 3px; }
        .group-label { font-size: 10px; color: #888; margin-bottom: 2px; font-weight: bold; }
        #sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100%; background: white; transform: translateX(-100%); transition: 0.3s; z-index: 1000; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 999; display: none; }
        #tab-bar { background: #f6f8fa; display: flex; border-bottom: 1px solid #d0d7de; height: 35px; }
        .tab { padding: 8px 15px; border-right: 1px solid #d0d7de; cursor: pointer; font-size: 11px; background: #eaeef2; }
        .tab.active { background: #fff; border-bottom: 2px solid var(--primary); font-weight: bold; }
        #editor-container { padding: 20px; overflow: auto; height: calc(100vh - 160px); background: #eee; }
        
        /* è¡¨æ ¼æ ¸å¿ƒæ¨£å¼ä¿®æ­£ */
        table { border-collapse: collapse; background: white; table-layout: fixed; width: auto; }
        td, th { 
            border: 1px solid #d0d7de; 
            padding: 0 4px; 
            font-size: 14px; 
            outline: none; 
            box-sizing: border-box; 
            overflow: hidden; 
            vertical-align: middle;
        }
        /* æ–‡å­—å®¹å™¨ï¼Œç”¨ä¾†ç²¾ç¢ºæ§åˆ¶é«˜åº¦èˆ‡æ›è¡Œ */
        .cell-content {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: block;
            box-sizing: border-box;
            line-height: 1.2;
        }
        .wrap-text { white-space: pre-wrap; word-break: break-all; }
        .line-text { white-space: pre; text-overflow: ellipsis; }

        th { background: #f6f8fa; font-size: 11px; color: #57606a; text-align: center; height: 30px; }
        td.selected { background: var(--select-bg) !important; outline: 1px solid var(--select-border); z-index: 2; }
    </style>
</head>
<body>

<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="header">
    <button class="btn" onclick="toggleSidebar()">ğŸ“ æª”æ¡ˆåˆ—è¡¨</button>
    <input type="password" id="token" placeholder="Token">
    <button class="btn" style="background:var(--primary); color:white;" onclick="fetchFiles()">Sync</button>
    <button class="btn" style="background:var(--success); color:white;" onclick="manualSave()">Save</button>
    <span id="status" style="font-size:11px; margin-left:auto;">Ready</span>
</div>

<div id="sidebar">
    <div style="padding:15px; font-weight:bold; border-bottom:1px solid #ddd;">é›²ç«¯æ–‡ä»¶ <button onclick="createNewFile()">+</button></div>
    <div id="file-items"></div>
</div>

<div id="toolbar">
    <div class="btn-group">
        <span class="group-label">æ­·å²</span>
        <div class="group-row"><button class="btn" onclick="undo()">â†©ï¸ Undo</button><button class="btn" onclick="redo()">â†ªï¸ Redo</button></div>
    </div>
    <div class="btn-group">
        <span class="group-label">æ ¼å¼</span>
        <div class="group-row"><button class="btn" onclick="setTextFormat('wrap')">Wrap</button><button class="btn" onclick="setTextFormat('line')">Line</button></div>
    </div>
    <div class="btn-group">
        <span class="group-label">å¢åˆªè¡Œåˆ—</span>
        <div class="group-row">
            <button class="btn" onclick="modifyTable('row', 'before')">è¡Œâ†‘</button>
            <button class="btn" onclick="modifyTable('row', 'after')">è¡Œâ†“</button>
            <button class="btn" onclick="modifyTable('col', 'before')">â†åˆ—</button>
            <button class="btn" onclick="modifyTable('col', 'after')">åˆ—â†’</button>
        </div>
        <div class="group-row">
            <button class="btn" style="color:var(--danger)" onclick="deleteSelected('row')">åˆªé¸å®šè¡Œ</button>
            <button class="btn" style="color:var(--danger)" onclick="deleteSelected('col')">åˆªé¸å®šåˆ—</button>
        </div>
    </div>
    <div class="btn-group">
        <span class="group-label">å¯¬é«˜èª¿æ•´ (Â±10%)</span>
        <div class="group-row">
            <button class="btn" onclick="resize('selection', 'row', 1.1)">é¸å®šé«˜+</button>
            <button class="btn" onclick="resize('selection', 'row', 0.9)">é¸å®šé«˜-</button>
            <button class="btn" onclick="resize('all', 'row', 1.1)">å…¨é«˜+</button>
            <button class="btn" onclick="resize('all', 'row', 0.9)">å…¨é«˜-</button>
        </div>
        <div class="group-row">
            <button class="btn" onclick="resize('selection', 'col', 1.1)">é¸å®šå¯¬+</button>
            <button class="btn" onclick="resize('selection', 'col', 0.9)">é¸å®šå¯¬-</button>
            <button class="btn" onclick="resize('all', 'col', 1.1)">å…¨å¯¬+</button>
            <button class="btn" onclick="resize('all', 'col', 0.9)">å…¨å¯¬-</button>
        </div>
    </div>
    <div class="btn-group" style="border:none;">
        <span class="group-label">å·¥å…·</span>
        <div class="group-row">
            <button class="btn" onclick="openImport()">ğŸ“‹ åŒ¯å…¥</button>
            <button class="btn" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º</button>
            <button class="btn" onclick="clearSelectedCells()">ğŸ§¹ æ¸…ç©º</button>
        </div>
    </div>
</div>

<div id="tab-bar"><div class="tab-add" onclick="addNewSheet()" style="padding:8px; cursor:pointer; color:green;">ï¼‹</div></div>

<div id="editor-container"><table id="main-table"></table></div>

<script>
    const REPO = "patrickwoolf/my-online-drive";
    let workbook = { "Sheet1": { data: [["","",""]], rowH: [35], colW: [100,100,100], format: "wrap" } };
    let activeSheet = "Sheet1", currentFile = null, currentSha = null, lastSavedData = "";
    let undoStack = [], redoStack = [], isSelecting = false, startCell = null, endCell = null;

    window.onload = () => {
        const saved = localStorage.getItem('gh_token');
        if (saved) { document.getElementById('token').value = saved; fetchFiles(); }
        initTable();
        document.addEventListener('mouseup', () => isSelecting = false);
    };

    function initTable() {
        const sheet = workbook[activeSheet], table = document.getElementById('main-table');
        table.innerHTML = "";
        const thead = document.createElement('tr');
        thead.appendChild(document.createElement('th'));
        for(let i=0; i<sheet.data[0].length; i++) {
            const th = document.createElement('th'); th.innerText = String.fromCharCode(65 + i);
            thead.appendChild(th);
        }
        table.appendChild(thead);
        sheet.data.forEach((rowData, r) => {
            const tr = document.createElement('tr');
            const th = document.createElement('th'); th.innerText = r + 1;
            tr.appendChild(th);
            rowData.forEach((cellData, c) => {
                const td = document.createElement('td');
                const div = document.createElement('div');
                div.className = `cell-content ${sheet.format === 'wrap' ? 'wrap-text' : 'line-text'}`;
                div.contentEditable = "true";
                div.innerText = cellData;
                div.onblur = () => { if(sheet.data[r][c] !== div.innerText) { pushHistory(); sheet.data[r][c] = div.innerText; } };
                td.onmousedown = () => { isSelecting = true; startCell = {r, c}; endCell = {r, c}; highlightRange(); };
                td.onmouseover = () => { if(isSelecting) { endCell = {r, c}; highlightRange(); } };
                td.appendChild(div);
                td.dataset.r = r; td.dataset.c = c;
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
        renderStyles();
        renderTabs();
    }

    function renderStyles() {
        const sheet = workbook[activeSheet], rows = document.getElementById('main-table').rows;
        if(!rows.length) return;
        for (let j = 0; j < sheet.data[0].length; j++) {
            const w = (sheet.colW[j] || 100) + 'px';
            for (let i = 0; i < rows.length; i++) {
                const cell = rows[i].cells[j+1];
                if (cell) { cell.style.width = w; cell.style.minWidth = w; cell.style.maxWidth = w; }
            }
        }
        for (let i = 0; i < sheet.data.length; i++) {
            const h = (sheet.rowH[i] || 35) + 'px';
            const row = rows[i+1];
            if (row) {
                Array.from(row.cells).forEach(cell => {
                    cell.style.height = h;
                    if(cell.firstChild) cell.firstChild.style.height = h;
                });
            }
        }
    }

    function resize(scope, type, factor) {
        pushHistory();
        const sheet = workbook[activeSheet];
        let targets = [];
        if (scope === 'selection') {
            const range = getSelectedRange() || (getFocus() ? {rMin: getFocus().r, rMax: getFocus().r, cMin: getFocus().c, cMax: getFocus().c} : null);
            if (!range) return;
            if (type === 'row') for(let i=range.rMin; i<=range.rMax; i++) targets.push(i);
            else for(let i=range.cMin; i<=range.cMax; i++) targets.push(i);
        } else {
            if (type === 'row') sheet.data.forEach((_, i) => targets.push(i));
            else sheet.data[0].forEach((_, i) => targets.push(i));
        }
        targets.forEach(idx => {
            if (type === 'row') sheet.rowH[idx] = Math.max(24, Math.round((sheet.rowH[idx] || 35) * factor));
            else sheet.colW[idx] = Math.max(24, Math.round((sheet.colW[idx] || 100) * factor));
        });
        renderStyles();
    }

    function getSelectedRange() {
        const sel = document.querySelectorAll('td.selected');
        if(!sel.length) return null;
        let rMin=999, rMax=0, cMin=999, cMax=0;
        sel.forEach(td => {
            const r=parseInt(td.dataset.r), c=parseInt(td.dataset.c);
            rMin=Math.min(rMin,r); rMax=Math.max(rMax,r); cMin=Math.min(cMin,c); cMax=Math.max(cMax,c);
        });
        return {rMin, rMax, cMin, cMax};
    }
    function getFocus() {
        const node = window.getSelection().anchorNode;
        const td = node?.parentElement?.closest('td');
        return td ? { r: parseInt(td.dataset.r), c: parseInt(td.dataset.c) } : null;
    }
    function highlightRange() {
        const rMin=Math.min(startCell.r, endCell.r), rMax=Math.max(startCell.r, endCell.r);
        const cMin=Math.min(startCell.c, endCell.c), cMax=Math.max(startCell.c, endCell.c);
        document.querySelectorAll('td').forEach(td => {
            const r=parseInt(td.dataset.r), c=parseInt(td.dataset.c);
            td.classList.toggle('selected', r>=rMin && r<=rMax && c>=cMin && c<=cMax);
        });
    }
    function pushHistory() { undoStack.push(JSON.stringify(workbook)); redoStack=[]; if(undoStack.length>50) undoStack.shift(); }
    function undo() { if(undoStack.length) { redoStack.push(JSON.stringify(workbook)); workbook=JSON.parse(undoStack.pop()); initTable(); } }
    function redo() { if(redoStack.length) { undoStack.push(JSON.stringify(workbook)); workbook=JSON.parse(redoStack.pop()); initTable(); } }
    function setTextFormat(t) { pushHistory(); workbook[activeSheet].format=t; initTable(); }
    function modifyTable(t, a) { pushHistory(); const f=getFocus()||{r:0,c:0}; let s=workbook[activeSheet]; if(t==='row'){ const p=a==='before'?f.r:f.r+1; s.data.splice(p,0,new Array(s.data[0].length).fill("")); s.rowH.splice(p,0,35); }else{ const p=a==='before'?f.c:f.c+1; s.data.forEach(r=>r.splice(p,0,"")); s.colW.splice(p,0,100); } initTable(); }
    function deleteSelected(t) { const r=getSelectedRange(); if(!r) return; pushHistory(); let s=workbook[activeSheet]; if(t==='row'){ s.data.splice(r.rMin, r.rMax-r.rMin+1); s.rowH.splice(r.rMin, r.rMax-r.rMin+1); }else{ s.data.forEach(row=>row.splice(r.cMin, r.cMax-r.cMin+1)); s.colW.splice(r.cMin, r.cMax-r.cMin+1); } initTable(); }
    function clearSelectedCells() { const sel=document.querySelectorAll('td.selected'); if(!sel.length) return; pushHistory(); sel.forEach(td=>{ const r=td.dataset.r, c=td.dataset.c; workbook[activeSheet].data[r][c]=""; td.firstChild.innerText=""; }); }
    function toggleSidebar() { const open=document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').style.display=open?'block':'none'; }
    function renderTabs() { const bar=document.getElementById('tab-bar'); bar.querySelectorAll('.tab').forEach(t=>t.remove()); Object.keys(workbook).forEach(name=>{ const div=document.createElement('div'); div.className=`tab ${name===activeSheet?'active':''}`; div.innerText=name; div.onclick=()=> { activeSheet=name; initTable(); }; bar.insertBefore(div, bar.firstChild); }); }
    async function fetchFiles() { const token=document.getElementById('token').value; localStorage.setItem('gh_token', token); const res=await fetch(`https://api.github.com/repos/${REPO}/contents/`,{headers:{'Authorization':`token ${token}`}}); const files=await res.json(); const list=document.getElementById('file-items'); list.innerHTML=""; files.filter(f=>f.name.endsWith('.json')).forEach(f=>{ const d=document.createElement('div'); d.innerText=f.name; d.onclick=()=>loadFile(f.name); list.appendChild(d); }); }
    async function loadFile(n) { toggleSidebar(); const res=await fetch(`https://api.github.com/repos/${REPO}/contents/${n}`,{headers:{'Authorization':`token ${document.getElementById('token').value}`}}); const j=await res.json(); currentFile=n; currentSha=j.sha; workbook=JSON.parse(pako.ungzip(new Uint8Array(atob(j.content).split('').map(c=>c.charCodeAt(0))),{to:'string'})); activeSheet=Object.keys(workbook)[0]; initTable(); }
    async function saveToCloud() { const s=JSON.stringify(workbook); await fetch(`https://api.github.com/repos/${REPO}/contents/${currentFile}`,{method:'PUT',headers:{'Authorization':`token ${document.getElementById('token').value}`},body:JSON.stringify({message:"Save",content:btoa(String.fromCharCode.apply(null,pako.gzip(s))),sha:currentSha})}).then(r=>r.json()).then(j=>{if(j.content)currentSha=j.content.sha;}); }
    function manualSave() { if(currentFile) saveToCloud(); }
</script>
</body>
</html>
