<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Drive V13 - Excel Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root { --primary: #0969da; --success: #2ea44f; --danger: #cf222e; --gh-dark: #24292f; --select-bg: #e7f3ff; --select-border: #0969da; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f6f8fa; overflow: hidden; user-select: none; }
        #header { background: var(--gh-dark); color: white; padding: 8px 12px; display: flex; gap: 10px; align-items: center; height: 45px; box-sizing: border-box; z-index: 300; position: relative; }
        #header input { background: #333; border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; width: 80px; flex-grow: 1; }
        #toolbar { background: #fff; border-bottom: 1px solid #d0d7de; padding: 8px; display: flex; gap: 5px; align-items: center; overflow-x: auto; position: relative; z-index: 10; }
        .btn { padding: 6px 10px; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; background: #f6f8fa; font-size: 12px; font-weight: 600; white-space: nowrap; }
        .btn:active { opacity: 0.7; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-group { display: flex; gap: 2px; border-right: 1px solid #ddd; padding-right: 5px; margin-right: 5px; }
        #sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100%; background: white; transform: translateX(-100%); transition: 0.3s; z-index: 1000; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 999; display: none; }
        #sidebar-overlay.visible { display: block; }
        .file-item { padding: 12px 20px; border-bottom: 1px solid #eee; cursor: pointer; }
        #tab-bar { background: #f6f8fa; display: flex; border-bottom: 1px solid #d0d7de; overflow-x: auto; height: 35px; }
        .tab { padding: 8px 15px; border-right: 1px solid #d0d7de; cursor: pointer; font-size: 11px; background: #eaeef2; white-space: nowrap; }
        .tab.active { background: #fff; border-bottom: 2px solid var(--primary); font-weight: bold; }
        #editor-container { padding: 20px; overflow: auto; height: calc(100vh - 125px); position: relative; }
        table { border-collapse: collapse; background: white; transform-origin: top left; transition: transform 0.1s; table-layout: fixed; }
        td, th { border: 1px solid #d0d7de; padding: 4px 8px; font-size: 14px; outline: none; box-sizing: border-box; overflow: hidden; word-break: break-all; white-space: pre-wrap; line-height: 1.2; }
        th { background: #f6f8fa; font-size: 11px; color: #57606a; text-align: center; }
        td.selected { background: var(--select-bg) !important; outline: 1px solid var(--select-border); z-index: 2; }
        td:focus { background: white; outline: 2px solid var(--primary); z-index: 5; }
        .zoom-info { font-family: monospace; font-size: 13px; min-width: 45px; text-align: center; }
    </style>
</head>
<body>

<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="header">
    <button class="btn" style="background:transparent; color:white;" onclick="toggleSidebar()">üìÅ</button>
    <input type="password" id="token" placeholder="Token">
    <button class="btn" style="background:var(--primary); color:white; border:none;" onclick="fetchFiles()">Sync</button>
    <button class="btn" style="background:var(--success); color:white; border:none;" onclick="manualSave()">Save</button>
    <span id="status" style="font-size:11px; margin-left:auto;">Ready</span>
</div>

<div id="sidebar">
    <div style="padding:15px; font-weight:bold; background:#f6f8fa; border-bottom:1px solid #ddd;">Cloud Files <button onclick="createNewFile()" style="float:right">+</button></div>
    <div id="file-items"></div>
</div>

<div id="toolbar">
    <div class="btn-group">
        <button class="btn" id="undoBtn" onclick="undo()">‚Ü©Ô∏è</button>
        <button class="btn" id="redoBtn" onclick="redo()">‚Ü™Ô∏è</button>
    </div>
    <div class="btn-group">
        <button class="btn" onclick="modifyTable('row', 'before')">Ë°å‚Üë</button>
        <button class="btn" onclick="modifyTable('row', 'after')">Ë°å‚Üì</button>
        <button class="btn" style="color:var(--danger)" onclick="deleteSelected('row')">‚úÇÔ∏èË°å</button>
    </div>
    <div class="btn-group">
        <button class="btn" onclick="modifyTable('col', 'before')">‚ÜêÂàó</button>
        <button class="btn" onclick="modifyTable('col', 'after')">Âàó‚Üí</button>
        <button class="btn" style="color:var(--danger)" onclick="deleteSelected('col')">‚úÇÔ∏èÂàó</button>
    </div>
    <button class="btn" onclick="changeZoom(-0.1)">‚ûñ</button>
    <span class="zoom-info" id="zoom-text">100%</span>
    <button class="btn" onclick="changeZoom(0.1)">‚ûï</button>
</div>

<div id="tab-bar"><div class="tab-add" onclick="addNewSheet()" style="padding:8px; cursor:pointer; color:green;">Ôºã</div></div>

<div id="editor-container">
    <table id="main-table" onpaste="handlePaste(event)"></table>
</div>

<script>
    const REPO = "patrickwoolf/my-online-drive";
    let workbook = { "Sheet1": { data: [["","",""]], rowH: [35], colW: [100,100,100] } };
    let activeSheet = "Sheet1";
    let currentFile = null, currentSha = null, currentZoom = 1.0, lastSavedData = "";
    let undoStack = [], redoStack = [];
    let isSelecting = false, startCell = null, endCell = null;

    window.onload = () => {
        const saved = localStorage.getItem('gh_token');
        if (saved) { document.getElementById('token').value = saved; fetchFiles(); }
        initTable();
        setInterval(autoSave, 30000);
        
        window.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if (document.activeElement.tagName !== 'TD') clearSelectedCells();
            }
        });
        document.addEventListener('mouseup', () => { isSelecting = false; });
    };

    function pushHistory() {
        undoStack.push(JSON.stringify(workbook));
        redoStack = [];
        if (undoStack.length > 50) undoStack.shift();
        updateHistoryButtons();
    }

    function undo() {
        if (!undoStack.length) return;
        redoStack.push(JSON.stringify(workbook));
        workbook = JSON.parse(undoStack.pop());
        initTable();
        updateHistoryButtons();
    }

    function redo() {
        if (!redoStack.length) return;
        undoStack.push(JSON.stringify(workbook));
        workbook = JSON.parse(redoStack.pop());
        initTable();
        updateHistoryButtons();
    }

    function updateHistoryButtons() {
        document.getElementById('undoBtn').disabled = !undoStack.length;
        document.getElementById('redoBtn').disabled = !redoStack.length;
    }

    // --- Excel Fix: The Paste Handler ---
    function handlePaste(e) {
        e.preventDefault();
        const clipboardData = e.clipboardData || window.clipboardData;
        const text = clipboardData.getData('text');
        if (!text) return;

        // Determine paste start point: Selected range top-left OR currently focused cell
        const range = getSelectedRange();
        const focus = getFocus();
        const startR = range ? range.rMin : (focus ? focus.r : 0);
        const startC = range ? range.cMin : (focus ? focus.c : 0);

        pushHistory();
        let sheet = workbook[activeSheet];

        // Sanitize Excel logic: 
        // 1. Split rows. 2. Split columns by Tab. 3. Strip surrounding quotes added by Excel for multi-line cells.
        const rows = text.split(/\r\n|\n|\r/).filter((row, i, arr) => i < arr.length - 1 || row.trim() !== "").map(row => {
            return row.split('\t').map(cell => {
                let c = cell.trim();
                if (c.startsWith('"') && c.endsWith('"')) c = c.slice(1, -1).replace(/""/g, '"');
                return c;
            });
        });

        rows.forEach((rowData, rIdx) => {
            const targetR = startR + rIdx;
            // Expand Rows
            while (targetR >= sheet.data.length) {
                sheet.data.push(new Array(sheet.data[0].length).fill(""));
                sheet.rowH.push(35);
            }
            rowData.forEach((val, cIdx) => {
                const targetC = startC + cIdx;
                // Expand Columns
                while (targetC >= sheet.data[0].length) {
                    sheet.data.forEach(r => r.push(""));
                    sheet.colW.push(100);
                }
                sheet.data[targetR][targetC] = val;
            });
        });

        initTable();
    }

    function initTable() {
        const sheet = workbook[activeSheet];
        const table = document.getElementById('main-table');
        table.innerHTML = "";
        
        const thead = document.createElement('tr');
        thead.appendChild(document.createElement('th'));
        for(let i=0; i<sheet.data[0].length; i++) {
            const th = document.createElement('th'); th.innerText = String.fromCharCode(65 + i);
            thead.appendChild(th);
        }
        table.appendChild(thead);

        sheet.data.forEach((rowData, r) => {
            const tr = document.createElement('tr');
            const th = document.createElement('th'); th.innerText = r + 1;
            tr.appendChild(th);
            rowData.forEach((cellData, c) => {
                const td = document.createElement('td');
                td.contentEditable = "true";
                td.innerText = cellData;
                td.dataset.r = r; td.dataset.c = c;
                td.onmousedown = (e) => { isSelecting = true; startCell = {r, c}; endCell = {r, c}; highlightRange(); };
                td.onmouseover = () => { if(isSelecting) { endCell = {r, c}; highlightRange(); } };
                td.onblur = () => { 
                    if(sheet.data[r][c] !== td.innerText) { pushHistory(); sheet.data[r][c] = td.innerText; }
                };
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
        renderStyles();
        renderTabs();
    }

    function highlightRange() {
        const rMin = Math.min(startCell.r, endCell.r), rMax = Math.max(startCell.r, endCell.r);
        const cMin = Math.min(startCell.c, endCell.c), cMax = Math.max(startCell.c, endCell.c);
        document.querySelectorAll('td').forEach(td => {
            const r = parseInt(td.dataset.r), c = parseInt(td.dataset.c);
            td.classList.toggle('selected', r >= rMin && r <= rMax && c >= cMin && c <= cMax);
        });
    }

    function getSelectedRange() {
        const selected = document.querySelectorAll('td.selected');
        if (!selected.length) return null;
        let rMin = 999, rMax = 0, cMin = 999, cMax = 0;
        selected.forEach(td => {
            const r = parseInt(td.dataset.r), c = parseInt(td.dataset.c);
            rMin = Math.min(rMin, r); rMax = Math.max(rMax, r);
            cMin = Math.min(cMin, c); cMax = Math.max(cMax, c);
        });
        return { rMin, rMax, cMin, cMax };
    }

    function getFocus() {
        const sel = window.getSelection();
        if (!sel.rangeCount) return null;
        let node = sel.anchorNode;
        while (node && node.tagName !== 'TD') node = node.parentElement;
        if (!node) return null;
        return { r: parseInt(node.dataset.r), c: parseInt(node.dataset.c) };
    }

    function clearSelectedCells() {
        const selected = document.querySelectorAll('td.selected');
        if (!selected.length) return;
        pushHistory();
        selected.forEach(td => {
            workbook[activeSheet].data[td.dataset.r][td.dataset.c] = "";
            td.innerText = "";
        });
    }

    function modifyTable(type, action) {
        pushHistory();
        const focus = getFocus() || {r:0, c:0};
        let sheet = workbook[activeSheet];
        if (type === 'row') {
            const pos = (action === 'before') ? focus.r : focus.r + 1;
            sheet.data.splice(pos, 0, new Array(sheet.data[0].length).fill(""));
            sheet.rowH.splice(pos, 0, 35);
        } else {
            const pos = (action === 'before') ? focus.c : focus.c + 1;
            sheet.data.forEach(row => row.splice(pos, 0, ""));
            sheet.colW.splice(pos, 0, 100);
        }
        initTable();
    }

    function deleteSelected(type) {
        const range = getSelectedRange();
        if (!range) return;
        pushHistory();
        let sheet = workbook[activeSheet];
        if (type === 'row') {
            sheet.data.splice(range.rMin, range.rMax - range.rMin + 1);
            sheet.rowH.splice(range.rMin, range.rMax - range.rMin + 1);
        } else {
            sheet.data.forEach(row => row.splice(range.cMin, range.cMax - range.cMin + 1));
            sheet.colW.splice(range.cMin, range.cMax - range.cMin + 1);
        }
        initTable();
    }

    function renderStyles() {
        const sheet = workbook[activeSheet];
        const rows = document.getElementById('main-table').rows;
        if(!rows.length) return;
        for (let j = 0; j < sheet.colW.length; j++) {
            const w = sheet.colW[j] + 'px';
            for (let i = 0; i < rows.length; i++) {
                const cell = rows[i].cells[j+1];
                if (cell) { cell.style.width = w; cell.style.minWidth = w; }
            }
        }
    }

    function changeZoom(delta) {
        currentZoom = Math.max(0.1, Math.min(3.0, Math.round((currentZoom + delta) * 10) / 10));
        document.getElementById('main-table').style.transform = `scale(${currentZoom})`;
        document.getElementById('zoom-text').innerText = Math.round(currentZoom * 100) + "%";
    }

    function toggleSidebar() {
        const open = document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebar-overlay').classList.toggle('visible', open);
    }

    function renderTabs() {
        const bar = document.getElementById('tab-bar');
        bar.querySelectorAll('.tab').forEach(t => t.remove());
        Object.keys(workbook).forEach(name => {
            const div = document.createElement('div');
            div.className = `tab ${name === activeSheet ? 'active' : ''}`;
            div.innerText = name;
            div.onclick = () => { activeSheet = name; initTable(); };
            bar.insertBefore(div, bar.firstChild);
        });
    }

    async function fetchFiles() {
        const token = document.getElementById('token').value;
        if(!token) return;
        localStorage.setItem('gh_token', token);
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/`, { headers: { 'Authorization': `token ${token}` } });
        const files = await res.json();
        const list = document.getElementById('file-items');
        list.innerHTML = "";
        files.filter(f => f.name.endsWith('.json')).forEach(f => {
            const d = document.createElement('div'); d.className = "file-item"; d.innerText = f.name;
            d.onclick = () => loadFile(f.name); list.appendChild(d);
        });
    }

    async function loadFile(name) {
        toggleSidebar(); document.getElementById('status').innerText = "Loading...";
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${name}`, { headers: { 'Authorization': `token ${document.getElementById('token').value}` } });
        const json = await res.json();
        currentFile = name; currentSha = json.sha;
        const content = JSON.parse(pako.ungzip(new Uint8Array(atob(json.content).split('').map(c => c.charCodeAt(0))), {to:'string'}));
        workbook = Array.isArray(content) ? { "Sheet1": { data: content, rowH: [], colW: [] } } : content;
        activeSheet = Object.keys(workbook)[0];
        lastSavedData = JSON.stringify(workbook);
        undoStack = []; redoStack = []; updateHistoryButtons();
        initTable(); document.getElementById('status').innerText = name;
    }

    async function saveToCloud() {
        const dataStr = JSON.stringify(workbook);
        const compressed = pako.gzip(dataStr);
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${currentFile}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${document.getElementById('token').value}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "AutoSave", content: btoa(String.fromCharCode.apply(null, compressed)), sha: currentSha })
        });
        const json = await res.json();
        if(json.content) { currentSha = json.content.sha; lastSavedData = dataStr; }
    }

    async function autoSave() {
        if (currentFile && JSON.stringify(workbook) !== lastSavedData) {
            document.getElementById('status').innerText = "Saving...";
            await saveToCloud();
            document.getElementById('status').innerText = currentFile;
        }
    }

    function manualSave() { if(currentFile) saveToCloud(); }
    function addNewSheet() {
        const name = prompt("ÂàÜÈ†ÅÂêçÁ®±:");
        if (name && !workbook[name]) { pushHistory(); workbook[name] = { data: [["",""]], rowH: [35], colW: [100,100] }; activeSheet = name; initTable(); }
    }
    function createNewFile() {
        let name = prompt("Êñ∞Ê™îÂêç:"); if (!name) return;
        if (!name.endsWith('.json')) name += '.json';
        currentFile = name; workbook = { "Sheet1": { data: [["",""]], rowH:[35], colW:[100,100] } };
        saveToCloud().then(fetchFiles);
    }
</script>
</body>
</html>
